<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Наявність деталей для індивідуального годинника</title>
  <style>
    /* ... [усі наявні стилі залишаються без змін] ... */

    #floatingDetails {
      position: absolute;
      left: calc(100% - 600px);
      width: 500px;
      background: #fafafa;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 100;
      display: none;
    }
  </style>
</head>
<body>
  <!-- ... [наявна розмітка без змін] ... -->

  <!-- Додано новий блок для "плаваючих" результатів -->
  <div id="floatingDetails">
    <div id="floatingLoader">Завантаження...</div>
    <div id="floatingNoResults">Нічого не знайдено.</div>
    <div class="search-results">
      <table id="floatingResultsTable">
        <thead><tr><th>Фото</th><th>Артикул</th><th>Назва</th><th>Прихід</th><th>Розхід</th><th>Залишок</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="total-info" id="floatingSummary"></div>
    </div>
  </div>

  <script>
    // ... [існуючі змінні залишаються]

    async function searchParts(isManual = true, modelElement = null) {
      const input = document.getElementById("watchInput").value.trim();
      const loader = isManual ? document.getElementById("loader") : document.getElementById("floatingLoader");
      const noRes = isManual ? document.getElementById("noResults") : document.getElementById("floatingNoResults");
      const table = isManual ? document.getElementById("resultsTable") : document.getElementById("floatingResultsTable");
      const summary = isManual ? document.getElementById("summary") : document.getElementById("floatingSummary");
      const floatBlock = document.getElementById("floatingDetails");

      loader.style.display = "block";
      noRes.style.display = "none";
      table.style.display = "none";
      summary.style.display = "none";
      if (!isManual) floatBlock.style.display = "block";

      const rawLink = await fetchSheet("Комплектації!A:D");
      const [, ...linkData] = rawLink;
      const partRows = linkData.filter(r => r[1]?.trim() === input);
      const parts = partRows.map(r => r[3]?.trim());
      if (!parts.length) {
        loader.style.display = "none";
        noRes.style.display = "block";
        return;
      }

      const rawDet = await fetchSheet("Деталі!A:F");
      const [, ...detailData] = rawDet;

      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";
      let total = 0;

      parts.forEach(a => {
        const d = detailData.find(r => r[1]?.trim() === a) || [];
        const name = d[2]?.trim() || "Без назви";
        const qty = parseInt(d[5] || "0", 10) || 0;
        total += qty;
        const img = `https://abertime.com.ua/image/data/price_google/all_price/big/SK-${a}.jpg`;

        const p = d[3] || "0", o = d[4] || "0", s = d[5] || "0";
        const isMissing = parseInt(s) === 0;
        const highlight = v => (isMissing && parseInt(v) === 0 ? `<span class="red-text">${v}</span>` : v);

        tbody.innerHTML += `
          <tr>
            <td><img src="${img}" onclick="window.open('${img}')"></td>
            <td>${a}</td>
            <td>${name}</td>
            <td>${highlight(p)}</td>
            <td>${highlight(o)}</td>
            <td>${highlight(s)}</td>
          </tr>
        `;
      });

      loader.style.display = "none";
      table.style.display = "table";
      summary.innerText = `Загальна кількість деталей: ${parts.length} | Сумарний залишок: ${total} од.`;
      summary.style.display = "block";

      if (!isManual && modelElement) {
        const offsetTop = modelElement.getBoundingClientRect().top + window.scrollY - 20;
        floatBlock.style.top = `${offsetTop}px`;
      }
    }

    function selectModelByArticle(article) {
      const index = allModels.findIndex(m => m.dataset.article === article);
      if (index !== -1) {
        setActiveModel(index);
        document.getElementById("watchInput").value = article;
        const modelElement = allModels[index];
        searchParts(false, modelElement);
      }
    }
  </script>
</body>
</html>
