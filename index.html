<!-- ПОВНИЙ ОНОВЛЕНИЙ КОД ЗА ЗАДАЧЕЮ -->

<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Наявність деталей для індивідуального годинника</title>
  <style>
    /* СТИЛІ — залишаються без змін (включно з floatingDetails та floatingResultsTable) */
    /* ... (усі CSS-стилі залишаються як у попередній версії) ... */
  </style>
</head>
<body>
  <!-- HTML — теж без змін, тільки додано floatingDetails -->

  <!-- Плаваюча таблиця для деталей біля моделі -->
  <div id="floatingDetails">
    <table id="floatingResultsTable">
      <thead><tr><th>Фото</th><th>Артикул</th><th>Назва</th><th>Прихід</th><th>Розхід</th><th>Залишок</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="total-info" id="floatingSummary"></div>
  </div>

  <script>
    async function searchParts(isManual = true) {
      const input = document.getElementById("watchInput").value.trim();

      const loader = document.getElementById("loader");
      const noRes = document.getElementById("noResults");
      const table = document.getElementById("resultsTable");
      const summary = document.getElementById("summary");

      const floatTable = document.getElementById("floatingResultsTable");
      const floatSummary = document.getElementById("floatingSummary");
      const floatBox = document.getElementById("floatingDetails");

      if (isManual) {
        loader.style.display = "block";
        noRes.style.display = "none";
        table.style.display = "none";
        summary.style.display = "none";
      } else {
        floatTable.style.display = "none";
        floatSummary.style.display = "none";
        floatBox.style.display = "block";
      }

      const rawLink = await fetchSheet("Комплектації!A:D");
      const [, ...linkData] = rawLink;
      const partRows = linkData.filter(r => r[1]?.trim() === input);
      const parts = partRows.map(r => r[3]?.trim());
      if (!parts.length) {
        if (isManual) {
          loader.style.display = "none";
          noRes.style.display = "block";
        } else {
          floatBox.style.display = "none";
        }
        return;
      }

      const rawDet = await fetchSheet("Деталі!A:F");
      const [, ...detailData] = rawDet;

      const tbody = isManual ? document.querySelector("#resultsTable tbody") : document.querySelector("#floatingResultsTable tbody");
      tbody.innerHTML = "";
      let total = 0;

      parts.forEach(a => {
        const d = detailData.find(r => r[1]?.trim() === a) || [];
        const name = d[2]?.trim() || "Без назви";
        const qty = parseInt(d[5] || "0", 10) || 0;
        total += qty;
        const img = `https://abertime.com.ua/image/data/price_google/all_price/big/SK-${a}.jpg`;

        const p = d[3] || "0", o = d[4] || "0", s = d[5] || "0";
        const isMissing = parseInt(s) === 0;
        const highlight = v => (isMissing && parseInt(v) === 0 ? `<span class='red-text'>${v}</span>` : v);

        tbody.innerHTML += `
          <tr>
            <td><img src="${img}" onclick="window.open('${img}')"></td>
            <td>${a}</td>
            <td>${name}</td>
            <td>${highlight(p)}</td>
            <td>${highlight(o)}</td>
            <td>${highlight(s)}</td>
          </tr>
        `;
      });

      if (isManual) {
        loader.style.display = "none";
        table.style.display = "table";
        summary.innerText = `Загальна кількість деталей: ${parts.length} | Сумарний залишок: ${total} од.`;
        summary.style.display = "block";
      } else {
        floatTable.style.display = "table";
        floatSummary.innerText = `Загальна кількість деталей: ${parts.length} | Сумарний залишок: ${total} од.`;
        floatSummary.style.display = "block";
      }
    }

    function selectModelByArticle(article) {
      const index = allModels.findIndex(m => m.dataset.article === article);
      if (index !== -1) {
        setActiveModel(index);
        const modelElement = allModels[index];
        const floating = document.getElementById('floatingDetails');
        const rect = modelElement.getBoundingClientRect();
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        floating.style.top = `${rect.top + scrollTop}px`;
        document.getElementById("watchInput").value = article;
        searchParts(false);
      }
    }
  </script>
</body>
</html>
